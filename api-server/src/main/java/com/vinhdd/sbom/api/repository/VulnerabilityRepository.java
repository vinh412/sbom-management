package com.vinhdd.sbom.api.repository;

import com.vinhdd.sbom.api.model.Vulnerability;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.Map;

public interface VulnerabilityRepository extends JpaRepository<Vulnerability, Long> {
    Vulnerability findByVulId(String vulId);

    @Query(value = "SELECT v.*, " +
            "json_agg(json_build_object('id', c.id, 'name', c.name, 'groupName', c.group_name, 'publisher', c.publisher, 'purl', c.purl)) AS components " +
            "FROM vulnerabilities v JOIN component_vulnerability cv ON v.id = cv.vulnerability_id JOIN components c ON cv.component_id = c.id WHERE v.vul_id = ?1 GROUP BY v.id", nativeQuery = true)
    Map<String, Object> getVulnerabilityWithComponentsByVulId(String vulId);
}
