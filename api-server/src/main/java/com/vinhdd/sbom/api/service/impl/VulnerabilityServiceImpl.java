package com.vinhdd.sbom.api.service.impl;

import com.vinhdd.sbom.api.dto.out.VulnerabilityDto;
import com.vinhdd.sbom.api.dto.queryout.VulnerabilitiesWithComponentsDtoQueryOut;
import com.vinhdd.sbom.api.dto.restTemplate.ComponentReportDto;
import com.vinhdd.sbom.api.model.Component;
import com.vinhdd.sbom.api.model.Vulnerability;
import com.vinhdd.sbom.api.repository.ComponentRepository;
import com.vinhdd.sbom.api.repository.VulnerabilityRepository;
import com.vinhdd.sbom.api.service.VulnerabilityService;
import com.vinhdd.sbom.api.util.helper.QueryResultMapper;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class VulnerabilityServiceImpl implements VulnerabilityService {
    private final RestTemplate restTemplate;
    private final ComponentRepository componentRepository;
    private final VulnerabilityRepository vulnerabilityRepository;
    private final QueryResultMapper queryResultMapper;

    @Override
    public List<ComponentReportDto> getVulnerabilityByComponentPurl(List<String> purls) {
        List<ComponentReportDto> result = new ArrayList<>();
        if (!purls.isEmpty()) {
            for (int i = 0; i <= purls.size() / 128; i++) {
                List<String> purlsBatch = purls.subList(i * 128, Math.min((i + 1) * 128, purls.size()));
                Map<String, List<String>> requestBody = Map.of("coordinates", purlsBatch);
                HttpEntity<Map<String, List<String>>> request = new HttpEntity<>(requestBody);
                String url = "https://ossindex.sonatype.org/api/v3/component-report";
                ResponseEntity<List<ComponentReportDto>> response = restTemplate.exchange(url, HttpMethod.POST, request, new ParameterizedTypeReference<>() {});
                List<ComponentReportDto> componentReports = response.getBody();
                if (componentReports != null) {
                    result.addAll(componentReports);
                }
            }
        }
        return result;
    }

    public void saveVulnerabilityReport(List<ComponentReportDto> componentReports) {
        // Save the report to the database
        componentReports.forEach(componentReport -> {
            // Save the report to the database
            componentReport.getVulnerabilities().forEach(vulnerabilityDto -> {
                Component component = componentRepository.findByPurl(componentReport.getCoordinates());
                Vulnerability vulnerability = vulnerabilityRepository.findByVulId(vulnerabilityDto.getId());
                // Save the vulnerability to the database
                if (vulnerability == null) {
                    vulnerability = vulnerabilityDto.toEntity();
                }
                vulnerability.addComponent(component);
                vulnerabilityRepository.save(vulnerability);
            });
        });
    }

    @Override
    public List<VulnerabilityDto> getAllVulnerabilities() {
        return vulnerabilityRepository.findAll().stream().map(VulnerabilityDto::from).toList();
    }

    @Override
    @Transactional
    public VulnerabilitiesWithComponentsDtoQueryOut getVulnerabilityByVulId(String id) {
        return queryResultMapper.mapResult(vulnerabilityRepository.getVulnerabilityWithComponentsByVulId(id), VulnerabilitiesWithComponentsDtoQueryOut.class);
    }
}
